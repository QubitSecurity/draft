# 필상 시스템 — Day 29 FinOps(비용 가시성·최적화) & 단위경제

1. **날짜**

* 2025-09-13

2. **목표**

* **서비스·리전·테넌트 단위 비용 가시화**와 **예산/알림/최적화 루프** 확정
* **단위경제(€C/레코드, €C/검색, €C/사건)** 지표를 표준화해 **마진 관리** 및 가격정책 근거 확보

---

3. **내용**

### A. 비용 수집 체계(태깅·원장)

* **리소스 태그 표준**: `svc`, `tier`, `env`, `region`, `tenant_id(optional)`, `owner`, `release_id`.
* **원장(Ledger)**: 시간별 `CostRecord { ts, region, svc, metric, qty, unit_cost, amount }` 집계.
* 공급자 청구(클라우드/통신/SMS)는 **일 단위 스냅샷**으로 정규화해 원장에 병합.

### B. 단위경제 정의(핵심 KPI)

* **CIR(Record)**: 인입 1건 처리 비용(수집→정규화→저장).
* **CQS(Query)**: 상위 5 쿼리 템플릿 평균 1회 비용.
* **CIN(Incident)**: 사건 1건 판정·알림까지 비용(증거 보관 제외/포함 2종).
* **NRR 비용 뷰**: 테넌트별 **총변동비/월**과 매출 대비 **Gross Margin**.

### C. 계측 소스 & 매핑

* 컴퓨팅: vCPU·RAM·스토리지·IO·네트워크 egress 단가 → `svc`별 분배 키(예: 인입 RPS, 인덱스 문서수).
* 솔라/저장소: **문서수/GB·월** 기준 배분.
* 알림: 채널별 단가(메일/SMS/웹훅) 실결제액으로 상계.
* 외부 TI: 호출 건수 × 단가(쿼터 초과 페널티 별도).

### D. 대시보드(역할별)

* **경영**: 리전·플랜별 마진, 상위 비용 유발자, 예산 대비 소모율.
* **SRE**: 서비스별 **€C/req**, 캐시 적중률 vs 비용, 샤드/레플리카 증감의 비용 영향.
* **CSM**: 테넌트별 비용·사용량·가격 플랜 적합도(업/다운그레이드 제안).

### E. 예산·알림(Guardrails)

* 예산 엔티티: `Budget { scope: svc|region|tenant|channel, period: M/Q, amount, threshold[] }`.
* 임계: 50/80/100% 도달 시 **슬랙+메일**, 110% 초과 시 **자동 완화 제안**(아래 F).
* **변동비 급증 감지**: 24h 이동평균 대비 +30% ↑ → 원인(릴리스/트래픽/실패재시도) 코릴레이션.

### F. 자동 최적화(권고 & 플래그)

* **캐시/TTL 재조정**: 쿼리 당 비용↑ & p95 정상 → TTL 상향 권고.
* **샤드/레플리카 조정**: 검색 QPS↓ 지속 시 레플리카 축소, 반대 상황 시 확대.
* **알림 합성/요약**: 동일 사건군 N건 → 1건으로 압축(중복 억제율 목표 ≥ 40%).
* **TI 호출 스로틀**: 캐시 적중률 < 60% & 비용 임계 초과 시 `ti.fetcher.enable=false` 지역 한시 적용.
* 권고는 **플래그 템플릿**으로 생성되어 한 번 클릭으로 적용(승인 규칙 준수).

### G. 비용 분배 규칙(정확성)

* 공통 인프라(게이트웨이/관측)는 **비례 배분 키**(트래픽·사용자수·테넌트수)로 분배.
* 배치/백그라운드 잡은 실행 시간·처리량으로 매핑, 실패/재시도 비용은 **별도 라벨**로 가시화.
* **3중 대사**: 원장 합계 = 공급자 송장 합계(±1%) = 리포트 합계.

### H. 리포트 & 정책

* 월별 **FinOps 리포트**: 상위 5 비용 항목, 절감액, 품질 영향(지연/오류) 상관.
* **가격정책 데이터**: 플랜 포함량·오버리지 단가 조정 시 단위경제 근거 자동 첨부.
* **리셀러**: 파트너 수익분배 계산 자동화(사용량·할인 반영).

### I. SLO 연동(비용-성능 균형)

* **비용 SLO**: `CIR_p95`, `CQS_p95`, `CIN_p95` 상한 정의(예: CIR_p95 ≤ ₩0.0009).
* 위반 시 제안 목록 생성 → **변경관리 L2**로 자동 RFC 발행(캐시/샤드/플래그).

### J. API/스키마(발췌)

* `GET /v1/finops/unit-cost?svc=search&region=kr&asOf=…` — 단위 비용 조회.
* `GET /v1/finops/tenant/{id}/margin` — 테넌트 마진·예산·권고.
* `POST /v1/finops/budgets` — 예산 생성/임계 설정.
* `GET /v1/finops/recommendations` — 자동 권고(플래그/샤드/TTL 제안).

---

4. **예시 설명 (KR 검색 비용 급증—11% 절감 사이클)**

1) `CQS_p95`가 **₩0.0042 → ₩0.0051**로 21% 상승, 예산 80% 경고 발화.
2) 대시에서 캐시 미스율↑(45%→68%), 신규 릴리스와 상관 확인. **권고**: `search.cache.ttl 30s → 90s`.
3) L2 변경으로 KR 5% 카나리 적용 → p95 0.78s 유지, **CQS_p95 ₩0.0039**로 하향.
4) 레플리카 3→2 축소(야간) + 알림 합성율 35%→51% 개선.
5) 월말 **FinOps 리포트**: 검색 비용 **−11%**, 성능 SLO 유지, ENT 2개 테넌트에 **다운그레이드 권고** 발송.

> 결과: **비용 가시화→가드레일→자동 권고→제어된 변경**의 반복 루프로 **마진 안정화**와 **SLO 준수**를 동시에 달성.
