# 필상 시스템 — Day 34 데이터 품질(DQ) 관리 · 스키마 진화( Schema Evolution ) · 백필(Backfill)

1. **날짜**

* 2025-09-25

2. **목표**

* 로그/사건/지표 데이터의 **품질 기준·검증·격리(Quarantine)** 체계를 수립
* **스키마 진화(Expand→Migrate→Contract)**와 **안전한 백필** 절차를 표준화

---

3. **내용**

### A. 데이터 품질 표준(핵심 지표)

* **완전성**: 필수 필드 결측률 `≤ 0.1%` (예: `ts, tenant_id, region, status`)
* **정합성**: 참조 규칙(`tenant_id`↔RLS, `region` 일치) 위반 `= 0`
* **정확성**: 파생 필드(`ip_bucket`, `param_sig`) 재계산 **오차율 ≤ 0.5%**
* **적시성**: 인입→인덱스 **지연 p95 ≤ 1.2s** / 백필 잡 **SLA 내 완료**
* **유효성**: 스키마/도메인 검사 실패율 `≤ 0.2%` (넘으면 **격리 모드** 진입)

**DQ 지표 수집**: `dq_null_rate`, `dq_type_error`, `dq_ref_violation`, `dq_latency_p95`, `dq_quarantine_size`.

---

### B. 스키마 관리 & 계약(Data Contract)

* **레지스트리**: `schema/{domain}/{collection}/vN.json` (JSON Schema + 주석)
* **호환 규칙**

  * *뒤호환 추가* (필드 추가/NULL 허용/기본값) → **Minor**
  * *파괴 변경* (삭제/타입 변경/제약 강화) → **Major** + 마이그 가이드 필수
* **검증 레이어**

  1. **인입 전**: 경량 JSON Schema (속도 우선, 실패 시 Soft-Error 라벨)
  2. **인덱싱 전**: 엄격 검사 + **Quarantine** (하드 에러 격리)
  3. **오프라인**: 배치 DQ 스캔(일 1회) + 리포트/알람

---

### C. 진화 절차(EMC: Expand → Migrate → Contract)

1. **Expand**: 새 필드 추가(기본값/NULL 허용), 컨슈머는 **옵셔널**로 처리
2. **Migrate**: 프로듀서/백필 잡으로 새 필드 채움(동일 기간 **Dual-Write**)
3. **Contract**: 구필드 사용 중단 확인(호출 5% 미만) 후 **구필드 Deprecate → 제거**

> **게이트**: 각 단계에 DQ 대시보드·컨슈머 호환 여부 체크(계약 테스트) 통과 필요.

---

### D. 백필(Backfill) 표준

* **범위 지정**: 기간/테넌트/컬렉션 + 예상 건수/시간(예: `2025-08-01~2025-09-01, T=ALL`)
* **리소스 가드**: QPS 상한·오프피크 스케줄·샤드 분산·체크포인트(ULID 커서)
* **멱등성**: `doc_id` 고정 + `backfill_job_id` 라벨, 재시작 가능
* **정확성 검증**: 샘플 1% 교차 비교(구↔신 필드), 오차율 초과 시 **중단/롤백**
* **관측**: `backfill_progress`, `backfill_error_rate`, `impact_p95_latency`

---

### E. 품질 가드레일 & 격리(Quarantine)

* **Soft-Error**: 형 변환/허용 범위 초과 → `x-warnings[]` 추가 후 통과
* **Hard-Error**: 필수 결측/타입 불일치/참조 위반 → `*_quarantine` 컬렉션에 격리
* **격리 처리**: 원인코드 기준 자동 교정 규칙(예: 잘못된 `status` 범위 수정), 실패 시 DLQ 유지·알림

---

### F. 운영/자동화

* **CI 게이트**: 스키마 회귀 체크(브레이킹 탐지), 컨슈머 호환 매트릭스 테스트
* **릴리스 연계**: EMC 각 단계는 **릴리스 노트 항목** 생성(되돌리기 키 포함)
* **알람**: `dq_null_rate > 0.1%` 또는 `dq_ref_violation > 0` 10분 지속 → **T1**
* **FinOps 연동**: 백필로 인한 인덱스 I/O/스토리지 증가를 **예산 트래커**에 반영

---

### G. 예시 스키마 변경(발췌)

**목표**: `src_ip_trunc`(문자열) → **표준화** `ip_bucket`(`/24 버킷, 키워드형)`

1. **Expand**

```json
// v12 (추가)
"ip_bucket": { "type":"string", "pattern":"^\\d+\\.\\d+\\.\\d+\\.0/24$", "x-optional": true }
```

2. **Migrate/Dual-Write**

* 인입 파서가 `ip_bucket = truncate(src_ip, 24)` 계산, 두 필드 모두 기록
* 백필 잡이 과거 문서의 `ip_bucket` 채움(오프피크, 샤드 분산)

3. **Contract**

* 2주 관찰 후 `src_ip_trunc` **Deprecated** → 소비자 전환 완료 확인 → 제거

---

### H. API/툴링(발췌)

* `GET /v1/schema/{collection}/effective` — 현재 스키마/버전/호환성
* `POST /v1/backfill` — 범위/속도/검증 옵션 지정(승인 2인)
* `GET /v1/dq/report?range=7d` — 품질 리포트(지표·격리 원인 Top-N)
* `POST /v1/quarantine/{id}:repair` — 격리 문서 자동 교정/재시도

---

4. **예시 설명 (ip_bucket 도입—무중단 스키마 진화 & 백필 3일 내 완료)**

1) **Expand**: `incidents_{region}`에 `ip_bucket` 필드 추가, 컨슈머는 **옵셔널**로 처리하도록 릴리스.
2) **Dual-Write** 시작: 인입 단계에서 `src_ip_trunc`와 `ip_bucket` 동시 기록, DQ 대시에서 오차율 추적(목표 ≤0.5%).
3) **Backfill**: 지난 60일 데이터 대상, 야간·샤드 분산·QPS 제한으로 48시간에 92% 완료, 총 3일 내 100% 달성.
4) **Contract**: 소비자(콘솔/리포트/알림 템플릿)가 `ip_bucket` 전환 확인 후 `src_ip_trunc` Deprecate → 제거.
5) 결과 DQ: 결측률 0.03%, 참조 위반 0, 성능 영향 p95 +0.07s(허용), FinOps 비용 +4% (일시적) → 한달 내 스냅샷 종료로 원복.

> 효과: **계약 기반 스키마 진화**와 **가드레일·격리·백필 표준** 덕분에 무중단으로 데이터 품질을 유지하면서도 진화가 가능하며, 성능/비용/운영 리스크를 예측 가능한 범위에서 통제.
