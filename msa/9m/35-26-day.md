# 필상 시스템 — Day 35 AI·Ops 에이전트(LLM) · 자동화 플레이북 · 안전가드

1. **날짜**

* 2025-09-26

2. **목표**

* **SOC 자동화 에이전트**로 티어-1/티어-2 작업(분류·증거 취합·초안 대응·플래그 조정)을 **30% 이상 감축**
* **프롬프트/툴/정책(OPA) 가드**로 **오류·과잉행동 방지**, **증거 중심 출력** 표준화

---

3. **내용**

### A. 아키텍처(Agentic Flow)

```
Incident(이벤트) → Orchestrator(루팅)
  ↳ Evidence Fetcher(로그/샘플/TI/EPKG)
  ↳ Reasoner(LLM, 컨텍스트 RAG)
  ↳ Action Planner(안전 템플릿)
  ↳ Executor(툴: Solr/Search, Rules API, Notify, Ticket)
  ↳ Verifier(규칙·SLO·OPA 평가)
  ↳ Recorder(감사/해시체인)
```

* **컨텍스트 소스**: `incidents_{region}`, `logs_raw_*`, `ti_cache`, 릴리스/룰 변경 이력, 런북 요약
* **결정권**: 기본 **제안 모드**(require human) → 특정 저위험 액션만 **자가 승인**(정책 허용 시)

### B. 역할 & 권한(스코프)

* `agent:read`(증거 조회), `agent:propose`(초안·티켓), `agent:execute.low`(저위험), `agent:execute.high`(금지, 인간 승인 필수)
* **OPA 정책**으로 액션 화이트리스트/근거 필수/리스크 한도(`risk_score ≤ 0.3`) 강제

### C. 프롬프트/출력 포맷(표준)

* **입력 헤더**: `incident_id, tenant, region, rule_id, time_range, ti.summary, saved_queries[]`
* **지시**: “**사실만**·**원로그 인용은 해시/링크**로, **결론에는 근거 키-값** 포함. 추정 금지.”
* **출력 스키마(JSON)**

```json
{
  "summary":"...",
  "verdict":"allow|review|block|info",
  "confidence": 0.0,
  "evidence": {
    "queries":[ "...saved_key...", "...raw query..." ],
    "samples": {"blocked":N,"ok":M},
    "ti": {"score":72,"labels":["scanner"]},
    "artifacts":["s3://.../EPKG#..."]
  },
  "proposed_actions":[
    {"type":"rule_delta","payload":{"rule_id":"WAF-941100","change":"whitelist:param_sig=ko_search"}, "risk":0.18},
    {"type":"notify","payload":{"target":"team-csirt","severity":"high"}, "risk":0.05}
  ],
  "limits":{"valid_for_minutes":30}
}
```

### D. 툴박스(Executors)

* **SearchTool**: 저장 템플릿 실행·샘플 10건 추출(랜덤/시간 분산)
* **DBV360 API**: 재판정 트리거/증거 패키지 링크 생성
* **Rules API**: *드래프트만* 생성(`channel=alpha`, `dry_run=true`)
* **Ticket/Notify**: 초안 작성·승인 대기 상태로 발행
* **Flags/Config**: **읽기만**(제안에 키/값 포함, 실행은 금지)

### E. 안전가드(OPA/Rego + 스로틀)

* **데이터 주권**: 교차 리전 쿼리·전송 **deny**
* **행동 제한**: `rule_delta`는 **드래프트**만, `kill_switch`·플래그 수정 **금지**
* **속도/비용 가드**: 에이전트 호출 p95 ≤ 8s, 초당 2회, 실패시 백오프
* **증거 필수**: `verdict` 존재 시 `samples.blocked|ok`와 `ti.score` 필수, 누락이면 **실행 금지**

### F. 평가·튜닝

* **정확도**: 인간 확정과 일치율(precision@allow/block) ≥ **90%**
* **효율**: 티켓 처리 리드타임 **−30%**, 수동 쿼리 실행 **−40%**
* **안전**: 잘못된 실행 0건(정책상 실행 자체가 불가), 제안 거절률/사유 트래킹
* **오류학습**: 거절 사유를 **프롬프트 패치**와 **룰/쿼리 개선 이슈**로 자동 전파

### G. 관측·감사

* SLI: `agent_latency_p95`, `proposal_accept_rate`, `auto_execute_rate(low)`, `rollback=0`
* 모든 요청/결정은 **감사 해시체인**으로 기록(`who/what/why/trace_id/prompt_hash`)

### H. 운영 절차

* **도입 단계**: `read→propose→execute.low` 3단계 롤아웃(테넌트 10%→25%→100%)
* **에스컬레이션**: T0/T1 시 자동 **제안 모드 전환**(실행 전면 중지)
* **런북 연계**: 제안 카드에 **해당 런북 섹션** 딥링크와 되돌리기 방법 포함

### I. API(발췌)

* `POST /v1/agent/analyze { incident_id }` — 요약/판정/제안 생성(실행 금지)
* `POST /v1/agent/execute { action_id }` — **저위험** 액션만, 2인 승인 옵션
* `POST /v1/agent/feedback { action_id, label: accept|reject, reason }` — 학습 피드백
* `GET /v1/agent/audit?since=…` — 결정/실행 로그 스트림

### J. 체크리스트

* [ ] 에이전트 권한 `read/propose`만으로 시작, `execute.low`는 **주간 리뷰** 후 활성
* [ ] 프롬프트에 **금지어/개인정보 노출 방지 규칙** 포함(마스킹 강제)
* [ ] 제안에는 **저장 쿼리 키** 우선 사용, 임의 Raw 쿼리는 검토자 승인 필요
* [ ] 실패/거절 케이스는 **재현 링크(EPKG/쿼리)** 필수 첨부
* [ ] 월간 평가 리포트(정확도/효율/안전) 기반로 플래그 조정

---

4. **예시 설명 (오탐 의심 자동화—제안→검토→드래프트 릴리스)**

1) `incident_id=01J…`, `WAF-941100` 사건 오픈 → Orchestrator가 에이전트 호출(p95 6.2s).
2) **Evidence Fetcher**가 템플릿 A/B 실행: `406/Blocked:1=25` vs `200=12`, `ti.score=14(저위험)` 수집.
3) **Reasoner**: `verdict=allow`, `confidence=0.81`, **근거**(샘플·TI·파라미터 시그니처=ko_search) 정리.
4) **Proposed Actions**:

   * a) `rule_delta`(화이트리스트 추가) **드래프트** 생성, `risk=0.18`
   * b) CSIRT 채널 **알림 초안**(요약/근거 링크)
5) **Verifier(OPA)**: 리전/KMS/권한·증거 체크 통과 → **실행은 보류**(인간 승인 필요)
6) 분석가가 콘솔에서 제안 확인 → a) **드래프트 승인** 후 KR-stg Shadow → Canary 5% 정상 → **stable 승격**
7) 사건 **Resolved**, 에이전트 레코드에 `accept` 피드백 저장 → 프롬프트/룰 개선에 반영.

> 결과: 에이전트는 **증거 요약·제안 자동화**로 분석가의 반복 작업을 줄이고, **정책 가드·드래프트 원칙**으로 안전을 확보—운영 민첩성과 품질을 동시에 향상.
