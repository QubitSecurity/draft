# 필상 시스템 — Day 38 소프트웨어 공급망 보안(Supply Chain) · SBOM · 서명/프로비넌스

1. **날짜**

* 2025-10-01

2. **목표**

* **코드→빌드→아티팩트→배포** 전 구간에 **무결성·추적성** 확립
* **SBOM·서명(Cosign)·프로비넌스(SLSA)** 표준화로 **변조·의존성 리스크** 최소화

---

3. **내용**

### A. 신뢰 체인(End-to-End)

* **Git 원장**: 보호 브랜치, 필수 리뷰 2인, **서명 커밋**(sigstore/gitsign), `gitleaks` 비밀 차단.
* **빌드**: CI는 **격리 러너**(Ephemeral), 캐시/비밀은 **OIDC+STS**로 단명 발급.
* **아티팩트**: 이미지·차트·SBOM에 **서명/프로비넌스** 첨부 → 레지스트리 업로드.
* **배포**: Admission에서 **서명 검증 + 정책(OPA/Gatekeeper)** 통과 시에만 실행.

### B. SBOM & 프로비넌스(표준)

* **형식**: CycloneDX(JSON) + SPDX 태그 요약.
* **생성**: 언어별 스캐너(`syft`, `pip/audit`, `npm ls --json`, `go version -m`)를 **멀티 스테이지**에 통합.
* **프로비넌스**: **SLSA v1.0** in-toto attestation(`builder id`, `source uri`, `git sha`, `reproducible: true/false`).
* **보존**: SBOM/attestation을 **아티팩트 스토어**와 레지스트리에 동시 저장(WORM, 3년).

### C. 서명/검증(이미지·차트·매니페스트)

* **서명**: `cosign sign --key kms://{region}/plura-build` (리전별 키)
* **검증**: Admission에서 `cosign verify --certificate-oidc-issuer` + **정책**

  * 허용 조건: (1) 조직 KMS 키로 서명, (2) SBOM 존재, (3) 취약점 게이트 통과
* **정책 예**: `plura.policy.supplychain.required = ["signature","sbom","provenance","vuln:high=0"]`

### D. 의존성 관리 & 취약점 게이트

* **소스 의존성**: `renovate`/`dependabot` 주간 PR, **핀(Pin)** 원칙(semver 범위 금지).
* **바이너리/베이스 이미지**: 월 1회 롤링, 긴급 CVE는 24–72h 내 갱신.
* **게이트**: `trivy fs/image` — **Critical/High=0**, Medium은 승인 시 예외(만료일 필수).
* **라이선스**: 허용 목록(예: MIT/Apache-2.0/BSD/ISC), **Copyleft** 사용 시 법무 승인.

### E. 레지스트리·배포 정책

* 레지스트리: **리전 로컬** 프라이빗 OCI + 미러. `:latest` 금지, **불변 태그**(`2025.10.1+sha`)
* **이미지 보존**: 운영 태그 90일, `stable/*` 180일.
* 배포는 **불변 digest** 사용(`image@sha256:…`), **이미지 풀 제한**(레지스트리 화이트리스트).

### F. 서드파티/프리빌트 수용 기준

* 수집/보안 제품 커넥터, 에이전트 등 **3rd 패키지**는 다음 충족 시만:

  1. 공급자 **SBOM/서명** 제공, 2) CVE 리포트(SLA), 3) 주권·데이터 경로 명시, 4) 샌드박스 검증 통과.
* **런타임 격리**: Wasm/Sidecar 샌드박스, **리소스 쿼터**와 네트워크 egress 제한.

### G. 사고 대응(공급망)

* **CVE 핫라인**: 취약점 알림 수신 → 영향 스캔(레지스트리 전수) → **차단/교체** 플로우 자동.
* **키 로테이션**: 서명 KMS 키 90일, **유출 의심** 시 즉시 폐기/대체 + 재서명(중요 아티팩트).
* **공급자 위반**: 계약상 **SLA/벌칙** 트리거, 대체 패키지 스위치.

### H. SLO/지표

* `sbom_coverage = 100%`, `signed_artifacts = 100%`, `prov_attest_coverage ≥ 95%`
* `cve_mttd ≤ 1h`(핫라인/피드 기반), `cve_mttr ≤ 48h`(High 기준)
* `unsigned_deploy=0`, `policy_deny_rate`(비율 관리)

### I. API/자동화(발췌)

* `POST /v1/supply/sbom/attach { image, sbom_uri }` — SBOM 등록/검증
* `GET /v1/supply/provenance?image=…` — 프로비넌스 조회(빌더/소스/sha)
* `POST /v1/supply/verify { image, policy }` — 서명·SBOM·CVE 게이트 일괄 검증
* `GET /v1/supply/cve/impact?cve=…` — 영향 서비스/태그 목록(대체/차단 제안 포함)

### J. 운영 체크리스트

* [ ] 모든 서비스 템플릿에 **SBOM 생성/서명 스텝** 포함
* [ ] Admission **서명·SBOM·취약점 게이트** 활성(스테이징→프로덕션 순)
* [ ] 베이스 이미지/의존성 **주간 PR**과 월간 롤링 계획 유지
* [ ] 예외 승인에 **만료일**·보완계획 기록, 기한 초과 시 자동 차단
* [ ] 레지스트리 접근은 **OIDC+STS** 단명 토큰, 감사 로그 해시체인

---

4. **예시 설명 (CVE-2025-XYZ 고위험 이미지—48시간 내 교체)**

1) 핫라인이 **CVE-2025-XYZ(High)** 알림 → 레지스트리 전수 스캔에서 `ingestor:2025.09.4+sha` 감염 확인.
2) `renovate`가 베이스 이미지 패치 PR 생성 → CI에서 **SBOM 재생성·서명**·CVE 0건 통과.
3) KR-stg **카나리 5%** → SLO 정상 → KR-prod 25→100% → JP 동일 절차.
4) Admission 로그에 **서명·프로비넌스 검증** 성공 기록, 취약 태그는 **차단 목록**에 등재.
5) 총 31시간 소요, `cve_mttr=31h` 달성. FinOps 영향 +1.6% (일시), 성능 영향 없음.

> 결과: **SBOM·서명·프로비넌스·게이트**가 연결된 공급망 보안 체계로, 외부/내부 변경에도 **무결성**과 **속도**를 동시에 확보—취약점 대응이 **측정 가능**하고 **반복 가능**해집니다.
