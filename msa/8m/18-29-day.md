# 필상 시스템 — Day 18 성능·부하 테스트 & 용량 계획

1. **날짜**

* 2025-08-29

2. **목표**

* **SLO 기반** 성능·부하 테스트 절차와 **용량 산정/스케일 규칙** 확정
* 인입(수집)·검색(질의)·사건(판정/알림) 경로의 **병목 탐지 → 개선 → 재검증**을 표준화

---

3. **내용**

### A. 워크로드 모델(초안)

* **인입(Write)**: 피크 8k RPS(일 평균 3k), 레코드 1.2KB 평균
* **검색(Read)**: 동시 사용자 120, 상위 5 쿼리 템플릿 80% 점유
* **사건/알림**: 사건 생성 200 rps(버스트), 알림 팬아웃 20 rps 평균
* **SLO(재확인)**:

  * 인입→사건 P95 ≤ 15s, 검색쿼리 P95 ≤ 800ms, 알림 P95 ≤ 10s
  * 가용성(콘솔/API) 99.9%

### B. 테스트 전략

* **모델**: Open(생성율 고정, 인입/알림) + Closed(동시 사용자, 검색/콘솔) 혼합
* **유형**: 연기(Smoke) → 기준선(Baseline) → 스트레스(한계치) → 내구성(8~24h) → 회귀(Baseline 비교)
* **도구**: k6(HTTP/WS), Locust(시나리오), Gatling(고RPS), Chaos Mesh(장애), Vegeta(간단 재현)

### C. 테스트 시나리오(핵심)

1. **Ingest-Only**: NDJSON 1.2KB, 3→8→12k RPS 램프, 샘플링/백프레셔 동작 확인
2. **Search-Top5**: 저장된 템플릿 5종(IP/URI/Rule/Facet/샘플링) 80:20 비율, 캐시효과 측정
3. **End-to-End**: Ingest→Detect→Incident→Notify 30분 내구성(릴리스 ID 태깅)
4. **DBV360 Burst**: `406/Blocked:1` 비율 20% 주입, 샘플러/쿼리/판정 지연 측정
5. **Failure Mix**: ZK 리더 재선출·Solr 리더 교체·Redis 지연 주입(50–200ms) 카오스

### D. 측정 지표(KPI)

* **레이트/지연**: p50/p95/p99, 타임라인(배포/플래그 전환 상관)
* **오류율**: HTTP 4xx/5xx, 파서 오류율, DLQ 증가율
* **큐·적체**: 스트림 레그, Solr 대기, DLQ 크기, 알림 재시도율
* **자원**: CPU/메모리/GC, 디스크 대기, 네트워크 포화도
* **비용지표**: 노드 시간(코어·GB·IO), 스토리지/전송, 알림 채널 사용량

### E. 합격 기준(게이트)

* Baseline: 상위 5 쿼리 **p95 ≤ 800ms**, 인입 정상화 **drop ≤ 0.1%**
* 스트레스(1.5× 피크): **우아한 열화**(샘플링·TTL 단축 발동, 오류율 ≤ 1%)
* 내구성(8h): 메모리/FD/핸들 누수 0, GC 중단 p99 ≤ 150ms, DLQ 자동 복구

### F. 스케일 규칙 & 용량 산정

* **Ingestor/Stream**: 소비자 1개당 1.5k RPS 처리 기준 → `desired = ceil(ingest_rps/1500) × 1.3`
* **Solr**: 샤드 1개당 80M 문서 또는 500GB 상한 → 피크 월 문서량/샤드 수 산정
* **Notifier**: 채널 워커 1개당 50 rps, 재시도율 10% 가정 시 60 rps 헤드룸
* **여유 헤드룸**: 평시 30% 유지(자동 스케일 업/다운 임계치 p95>0.8s, 큐 레그>30s)

### G. 튜닝 체크리스트

* **Nginx/HAProxy**: `worker_connections`, `reuseport`, `http2` 최적화, 커넥션 풀 확인
* **Ingestor**: 배치 쓰기 사이즈(10k), 파서 WASM 스레드/메모리 쿼터
* **Solr**: DocValues, `filterCache/queryResultCache` 사이즈, JVM G1/MaxRam %, 스냅샷 스로틀
* **Postgres**: 커넥션 풀(초과는 pgbouncer), 체크포인트/Autovacuum 파라미터
* **Redis/Stream**: `client-output-buffer-limit`, `hash-max-ziplist-*`, AOF rewrite 윈도우
* **Notifier**: 웹훅 타임아웃 3s, 병렬/레이트 조정, 실패 백오프 파라미터

### H. 테스트 자동화

* **Ci Stage `perf`**: 태그 `perf-*` PR에만 실행, **녹화/비교 대시보드** 생성
* **Budget**: 페이지/API별 **성능 예산**(예: 콘솔 TTI 4s, 쿼리 p95 800ms)—초과 시 빌드 실패
* **샘플 데이터팩**: 30·90일 합성 로그 팩(국문 URL, 다양한 UA/ASN/TI 포함)

### I. 결과 보고 & 회귀

* **레포트 구조**: 요약(합불) → 병목(Top-N) → 조치(코드/설정) → 재측정 결과 → 비용 영향
* **지식화**: 튜닝값을 IaC/차트로 커밋, 대시보드 스냅샷 아카이브, 런북 링크

---

4. **예시 설명 (Solr p95 1.3s 병목 개선 사이클)**

1) **Search-Top5** 수행 중 `facet-heavy` 쿼리 p95 1.3s, 캐시 미스율 65% 확인
2) 원인: `tenant_id` 파티션 편향 + DocValues 누락 필드, JVM G1 MaxPause 초과
3) 조치:

   * 스키마에 **DocValues 활성**, `qf` 재가중치(`param_sig^5` 유지, `uri` 낮춤)
   * 컬렉션 **샤드+1**, 대규모 테넌트 전용 샤드 분리, `filterCache` 2GB→3GB
   * JVM `-XX:MaxRAMPercentage=60`, `-XX:InitiatingHeapOccupancyPercent=35`
4) 재측정: p95 **0.72s**, 오류율 0.2%, CPU 15%p 감소, 스토리지 +8% (허용)
5) 회귀 보장: `perf` 파이프라인에 케이스 추가, 릴리스 노트에 성능 변경 기록

> 결과: **SLO 중심의 반복 측정→튜닝→검증** 체계를 고정하여 피크 트래픽에서도 **우아한 열화**와 **예측 가능한 확장**을 달성.
