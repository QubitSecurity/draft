# 필상 시스템 — Day 17 인입 파이프라인(수집·파싱·정규화)

1. **날짜**

* 2025-08-28

2. **목표**

* 웹/시스템 로그의 **안전한 수집→파싱→정규화→풍부화(ENRICH)** 파이프라인 표준 확정
* **멱등성·역호환·백프레셔**를 보장하고, **PII 최소화**·**샘플링/재생(Replay)**을 체계화

---

3. **내용**

### A. 수집 채널 & 에이전트

* **HTTP Ingest**: WAF/애플리케이션 → `POST /v1/ingest`(NDJSON 지원, 최대 5MB/req)
* **Syslog/TCP**: 네트워크 장비/보안제품(UTF-8 강제, BOM 제거)
* **File Tailer**(옵션): Fluent Bit/Vector → 게이트웨이로 중계
* **인증**: `IngestKey`(스코프·만료) + **IP 화이트리스트** + TLS1.2+
* **유효성**: `content-type`, `schema_version` 필수, 부적합 시 **400+사유 코드**

### B. 파싱 프레임워크(안전 우선)

* **샌드박스 파서**: WebAssembly/VM 격리, **CPU·메모리 쿼터**와 타임아웃(≤200ms/레코드)
* **파서 유형**: `json`, `kv`, `cef`, `regex`, `custom(wasm)`
* **버저닝**: `parser_id@vN` 강제, **Shadow/Dry-run** 병행(히트율·에러율 비교)
* **보안**: 정규식 **RE2 엔진**(Catastrophic Backtracking 방지), 바이트/문자율 제한

### C. 정규화 스키마(Core v1)

필수: `ts, tenant_id, region, src_ip, dst_host, method, uri, status, ua, bytes_in, bytes_out, blocked, rule_id, raw_hash`
파생: `param_sig, ip_bucket(/24), ts_epoch, trace_id, request_id`

```yaml
map:
  ts: $.time || $.@timestamp
  src_ip: $.client_ip || $.src
  uri: $.request.uri || $.cs-uri-stem
  blocked: $.waf.blocked ?: 0
  rule_id: $.waf.rule_id
derive:
  ip_bucket: truncate(src_ip,24)
  param_sig: sig(querystring || body)
```

### D. 풍부화(ENRICH) & PII 최소화

* **Geo/ASN**: 오프라인 MaxMind 등 지역 DB(리전 내 업데이트)
* **TI 평판**: `ti_cache` 조회(시간 제한 50ms, 실패 시 비동기 보강)
* **PII 정책**: 인덱스 투입 전 `src_ip_trunc`, `email_hash`, **원본은 S3(암호화) 보관**

### E. 멱등성·순서·중복 방지

* **멱등키**: `raw_hash=sha256(tenant_id|ts|src|dst|uri|body_trunc)`
* **순서**: 파티션 키 `tenant_id` + `occurred_at` 정렬(지연 수용 90s 윈도우)
* **중복**: 인입단/인덱싱단 **2중 중복 체크**(Bloom + KV 캐시)

### F. 백프레셔·샘플링

* **큐 수위**(p95 지연/적체량) 기준 자동 **샘플링/필드 축소**

  * 예: `ua`·`ref` 긴 필드 제거, `features_only` 모드(핵심 특징량만 유지)
* **고객 알림**: 한도 초과 시 CSM 알림 + 일시 스로틀(HTTP 429, Retry-After)

### G. 오류 처리 & DLQ

* **하드 에러**(스키마 불일치·파서 타임아웃): 레코드 격리 → `ingest.dlq`
* **소프트 에러**(필드 누락): 라벨링 후 통과(`x-warnings[]`)
* **DLQ 재생**: `POST /v1/dlq/{id}:replay`(파서 버전 지정 가능)

### H. 메트릭/로그(OTel)

* `ingest_rps`, `parse_error_rate`, `normalize_latency_p95`, `dedup_ratio`, `dlq_size`
* 로그 키: `tenant, parser_id, version, raw_bytes, recs, errs, trace_id`
* **SLO**: `normalize_latency_p95 ≤ 120ms`, `parse_error_rate ≤ 0.5%`

### I. 테스트/검증 도구

* **Fixture 셋**: 정상/경계/악성 페이로드 1000종, **국문/다국어 URL 인코딩** 포함
* **리플레이 툴**: NDJSON → 속도배율×(0.1~10x), **시간 왜곡 테스트** 지원
* **회귀 세트**: FP/Missed 대표 로그, 파서 업데이트 시 **Must-Pass**

### J. 운영 가드레일

* 본문 크기 제한: `≤ 256KB/레코드`, 멀티파트/바이너리는 **요약치만**(해시·길이·MIME)
* 위험 필드(스크립트/HTML)는 **이중 이스케이프**하여 화면 노출 방어
* 고객 템플릿 파서 업로드는 **검증/서명** 후 `alpha` 채널에서만 허용

---

4. **예시 설명 (한국어 검색어로 인한 WAF 차단—오탐 방지 흐름)**

1) 쇼핑몰 검색 요청이 **URL 인코딩 한국어** 파라미터 포함 → WAF가 `%27` 패턴으로 **406/Blocked:1** 기록
2) 인입 단계에서 파서는 `param_sig`를 **자연어 토큰**으로 인식·정규화, `payload_entropy` 낮음
3) ENRICH가 TI 조회(`ti_score=12` 저위험), `src_ip_trunc`만 인덱스 저장(PII 최소화)
4) 멱등키로 중복 제거 후 Solr 적재, **DBV360** 샘플러가 **동일 IP의 200 응답 10건**을 즉시 확보
5) Adjudicator가 **오탐**으로 판정(`confidence=0.82`) → 룰 델타(한국어 검색 파라미터 화이트리스트) 자동 제안
6) 전 과정 메트릭: `normalize_latency_p95=78ms`, `parse_error_rate=0.08%`, DLQ 0건
   → 결과: 파서/정규화·PII 최소화·멱등/샘플링이 결합돼 **안전·일관·재현 가능한 인입 파이프라인**을 확보.
