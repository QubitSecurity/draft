# 필상 시스템 — Day 7 Observability & SLO

1. **날짜**

* 2025-08-13

2. **목표**

* **관측(Logs·Metrics·Traces)** 표준과 **SLO/에러버짓** 규칙 확정
* **알람 루팅·런북** 최소 세트를 마련해 장애를 **10분 이내 탐지·진단** 가능

---

3. **내용**

### A. 관측 표준(OTel 우선)

* **Trace**: 모든 요청에 `trace_id/span_id`, **샘플링 10%**(핵심 경로 100%)

  * 핵심 경로: `Ingest → Detect → Incident → Notify`
* **Metrics**: RED/USE 원칙

  * RED(요청률·오류율·지연): 각 서비스의 `req_total`, `req_error_total`, `latency_ms_{p50,p95}`
  * USE(자원): CPU/메모리/디스크/네트워크 포화도
* **Logs**: JSON 구조화(필수 키: `ts, level, svc, tenant_id, region, msg, trace_id`)

  * PII/IP는 마스킹 규칙 적용(`ip_trunc: /24`, `email_hash: sha256`)

### B. 대시보드(역할별)

* **경영/운영 개요**: 리전별 가용성, 인입량, 사건/경보 추세, 에러버짓 소모
* **분석가 콘솔**: WAF/EDR 탐지 흐름, FP/Missed 비율, 룰 변화 영향
* **SRE**: 서비스 건강(RED/USE), 배포 코릴레이션(릴리스 ID, git SHA), DLQ 큐 크기
* **보안감사**: 접근 시도·권한 변경, 데이터 내보내기(egress) 알람 현황

### C. SLI/SLO(초안, 월 기준)

* **가용성(콘솔·API)**: 99.9%
* **인입→사건 생성 지연**:

  * SLI: `ingest_to_incident_latency_p95`
  * SLO: **≤ 15s** (월간 99%)
* **사건→알림 전달 지연**:

  * SLI: `incident_to_notify_latency_p95`
  * SLO: **≤ 10s** (월간 99%)
* **탐지 품질 지표**(정보): FP율 ≤ 2.0%, Missed 회귀 테스트 통과율 ≥ 99%
* **DLQ 체류 시간**: p95 ≤ 5m

**에러버짓 정책**

* 월간 에러버짓 소모 **>25%**: 신규 기능 릴리스 정지(핫픽스만)
* **>50%**: 릴리스 동결 + 성능/회귀 계획 의무 수립

### D. 알람 설계(노이즈 최소화)

* **게이트형 알람**: 단건이 아니라 **윈도우 추세** 기준(예: 5분 이동 평균)
* **다단계 임계치**

  1. 경고(WARN): SLO 임계의 70% 접근 → 슬랙 채널 통지
  2. 경보(ALERT): 100% 초과 5분 지속 → 온콜 페이지 + 티켓 자동 생성
* **루팅**

  * KR 장애: KR 온콜 → 10분 미해결 시 JP 온콜 백업
  * 보안 이벤트: CSIRT 채널 병행 통지(이중 승인 필요 시 워크플로우 연계)

### E. 연계/자동화

* **배포 코릴레이션**: 메트릭/로그에 `release_id, chart_ver` 레이블 자동 주입
* **실험/플래그**: Feature Flag 전환 시 **변경 이벤트**를 Trace Annotation으로 기록
* **합성 모니터링**: 1분 간격 헬스체크(콘솔 로그인/검색/티켓 생성 시나리오)

### F. 데이터 보존

* **Metrics**: 고해상도(10s) 7일, 1m 집계 30일, 5m 집계 13개월
* **Traces**: 샘플 10% 7일, 핵심 경로 100% 72시간
* **Logs**: 30일(검색 인덱스), 원본은 Object Storage 1년(암호화·불변 옵션)

### G. 운영 점검표(일/주/월)

* **일**: DLQ p95·알람 노이즈 비율·핫스팟 서비스 3개 점검
* **주**: 에러버짓 소모 리뷰·룰/모델 변경 영향 분석·FP 상위 5 패턴
* **월**: SLO 성적표·장애 RCA 100% 완료·용량 계획 업데이트

---

4. **예시 설명 (장애 감지→완화→복구 시나리오)**

1) 배포 후 **KR 리전**에서 `ingest_to_incident_latency_p95`가 18s로 상승, 5분 지속 → **ALERT** 발화
2) 대시보드에서 **릴리스 ID**와 지연 상승 상관 확인, 해당 릴리스로 트래픽 25% Canary 중
3) SRE가 **Auto-Rollback** 트리거 → 90초 내 이전 안정 태그 복귀, 지연 12s로 회복
4) DLQ 큐 급증 확인(파싱 오류) → 핫픽스 패치 적용 전까지 **샘플링 비율 5%로 감소**(완화)
5) RCA: 신규 파서의 엣지 케이스 누락; 테스트 케이스 추가·스키마 엄격화, **SLO 리포트**에 반영
6) 에러버짓 소모 12% 기록 → 릴리스 속도 유지, 다음 주에 **성능 회귀 테스트** 강화 배포 계획 확정

> 결과: 10분 내 탐지·자동 롤백·원인 국소화까지 완료, SLO 준수 및 알람 노이즈 최소화 유지.
