# 필상 시스템 — Day 9 탐지엔진(룰/모델) & DBV360 설계

1. **날짜**

* 2025-08-16

2. **목표**

* **탐지엔진**(룰/모델)의 구조·DSL·배포 원칙 확정
* **DBV360(오탐/미탐 판별)** 워크플로우·증거 스키마·평가 지표 정의

---

3. **내용**

### A. 탐지 아키텍처(개요)

* **Stream Processor**: 인입 이벤트(웹/EDR) → **Feature Extractor** → 룰/모델 실행 → `detect.verdict.v1` 발행
* **Rule Service**: 테넌트별 규칙(시그니처/행위/임곗값) 관리, **버전·릴리스 채널**(`alpha|beta|stable`)
* **Model Serving**: 온라인 추론(라이트 모델), 배치 재평가(헤비 모델) 병행
* **Feature Store(온디맨드)**: 짧은 보존(1~7일) 윈도우 통계(IP/URI/유저·세션 빈도, 엔트로피, 변이율)
* **TI Enricher**: `ti_cache` 교차조회(평판/가중치), 누락 시 비동기 보강

### B. 룰 DSL(요약)

* **구성**: `when`(매치) + `where`(필터) + `assert`(행위 조건) + `then`(액션)
* **액션**: `allow|block|review|tag("sql-injection")|score(+0.3)`
* **예시**

```yaml
rule_id: WAF-941100-tuned
version: 7
tenant: any
when: uri contains "%27" or param_sig in ["union_select","or_1_eq_1"]
where: dst_host == "shop.example.com" and method in ["GET","POST"]
assert:
  - freq(uri, 10m, by:src_ip) > p95(uri, 7d) * 1.5
then: review; tag("sql-injection"); score(+0.35)
```

* **원칙**: 뒤호환 우선, `dry-run/shadow` 채널 필수, **룰 변경 = 릴리스**(CI 컨트랙트 테스트)

### C. 특징량(Feature) 표준

* **요청 기반**: `len_uri`, `param_count`, `ascii_ratio`, `unicode_mixed`, `susp_char_rate`
* **행위 기반**(윈도우): `req_rate(ip,1m)`, `err_ratio(ip,5m)`, `status_mix(ip,30m)`
* **콘텐츠 기반**: `payload_entropy`, `keyword_tf(sig)`
* **TI 기반**: `ti_score(ip)`, `ti_seen(ip,24h)`, `asn_country_mismatch`

### D. DBV360(오탐·미탐 판별) 워크플로우

1. **사건 트리거**: `status=406 AND blocked=1` 또는 **의심 점수 ≥ θ**
2. **샘플링**:

   * A) **406/Blocked:1** 동일 사건키 최근 N건
   * B) **정상(200)** 동일 `src_ip`·`uri_sig` 랜덤 10건(시간대 분산)
   * C) **TI/평판** 스냅샷(점수/근거 링크)
3. **판정 엔진(Adjudicator)**: 근거 기반 **베이즈/히uristic** 혼합 스코어 → `verdict` + `confidence`
4. **증거화**: 아티팩트 패키징(원로그 해시·샘플·쿼리 템플릿·TI 리포트 URI)
5. **피드백 루프**: 콘솔에서 **‘오탐/정탐/재학습’** 선택 → 룰/모델에 **라벨 반영**(온라인 가중치 미세조정)

**증거 스키마(발췌)**

```json
{
  "incident_id":"01JC…",
  "verdict":"false_positive",
  "confidence":0.82,
  "evidence":{
    "samples":{"blocked":25,"ok":10},
    "facets":{"status":{"406":25,"200":10},"blocked":{"1":25,"0":10}},
    "ti":{"ip":"203.0.113.10","score":12,"sources":["abuseipdb"]},
    "queries":["q=rule_id:WAF-941100 AND …","q=src_ip:203.0.113.10 AND status:200 …"],
    "hashes":["sha256:…"]
  }
}
```

### E. 판정 규칙(밴드)

* `score ≥ 0.8` ⇒ **block**(즉시 차단/룰 강화 후보)
* `0.5 ≤ score < 0.8` ⇒ **review**(인간 확인·자동 샘플 확장)
* `score < 0.5` ⇒ **allow**(학습 데이터로만 반영)
* **설명가능성**: 상위 특징량 Top-K·TI 항목을 **근거**로 노출

### F. 평가·검증

* **오프라인 재생(Replay)**: 7·30·90일 로그 리플레이로 **회귀 테스트**
* **지표**: Precision/Recall, **FP율 ≤ 2%**, Missed 회귀 실패 ≤ 1%
* **A/B 안전장치**: 트래픽 10% Shadow → Canary(5→25→100%), **에러버짓 연동**
* **드리프트 감지**: 특징량 분포(KS-Test)·규칙 히트율 변동 모니터

### G. 운영·배포

* 룰/모델 아티팩트 서명(**SBOM**)·승인 워크플로우(2인 승인)
* **Kill-Switch**: 룰 ID/태그/테넌트 단위 즉시 비활성화
* **테넌트 오버레이**: 기본 룰 → 테넌트 델타(추가/완화) → 상속 체계

### H. API(발췌)

* `POST /v1/detect:adjudicate { incident_id }` — DBV360 수동 재판정
* `POST /v1/detect/feedback { incident_id, label }` — 라벨 반영
* `GET /v1/rules?channel=beta&tenant=T1` — 룰 페치(채널·테넌트별)

---

4. **예시 설명 (차단 로그의 오탐 판정 시나리오)**

1) `rule_id=WAF-941100, status=406, blocked=1` 사건 발생 → DBV360 자동 기동
2) **샘플링** 결과: 동일 IP의 **200 응답 10건**(결제/검색 섞임), `ti_score=12(저위험)`
3) 특징량: `req_rate` 정상 범위, `payload_entropy` 낮음, 파라미터가 **URL 인코딩된 한국어 검색어**
4) 판정: `score=0.18 → false_positive`, **증거 패키지** 저장 및 룰 델타 생성(한국어 검색 파라미터 화이트리스트)
5) 콘솔에서 **오탐 확정** → 자동 액션: 룰 버전 `v8-beta` 릴리스, 회귀 리플레이 통과 후 `stable` 승격, 해당 사건 **자동 종료**

> 결과: **증거 중심** 단계를 통해 불필요한 차단 감소, 정탐률 유지·운영비용 절감, 룰/모델 품질의 **지속적 학습** 사이클 확립.
